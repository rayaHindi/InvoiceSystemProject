<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Edit Invoice</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    
    <script>
        let itemIndex = [[${invoiceItems.size()}]]; // Track the number of existing items
        let deletedItems = []; // Store deleted item IDs

        function addItem() {
            const itemSelect = document.getElementById("itemSelect");
            const quantityInput = document.getElementById("quantityInput");
            const priceInput = document.getElementById("priceInput");
            const itemTable = document.getElementById("invoiceItemsTable").querySelector("tbody");

            const itemId = itemSelect.value;
            const itemName = itemSelect.options[itemSelect.selectedIndex].text;
            const itemPrice = parseFloat(priceInput.value);
            const quantity = parseInt(quantityInput.value);

            if (!itemId || itemPrice <= 0 || quantity <= 0) {
                alert("Please select a valid item, enter a quantity, and set a price.");
                return;
            }

            const newRow = document.createElement("tr");
            newRow.innerHTML = `
                <td>
                    <input type="hidden" name="itemIds" value="${itemId}">
                    ${itemName}
                </td>
                <td>
                    <input type="number" name="prices" value="${itemPrice.toFixed(2)}" step="0.01" min="0" onchange="updateTotal()">
                </td>
                <td>
                    <input type="number" name="quantities" value="${quantity}" min="1" onchange="updateTotal()">
                </td>
                <td>
                    <button type="button" onclick="removeItem(this, null)">Remove</button>
                </td>
            `;

            itemTable.appendChild(newRow);
            itemIndex++; 
            quantityInput.value = "";
            priceInput.value = "";
            updateTotal();
        }

        function removeItem(button, itemId) {
            const row = button.closest("tr");
            row.remove();

            if (itemId) {
                deletedItems.push(itemId);
                document.getElementById("deletedItemsInput").value = deletedItems.join(",");
            }
            updateTotal();
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll("#invoiceItemsTable tbody tr").forEach(row => {
                const price = parseFloat(row.querySelector("input[name='prices']").value) || 0;
                const quantity = parseInt(row.querySelector("input[name='quantities']").value) || 0;
                total += price * quantity;
            });
            document.getElementById("totalAmount").textContent = total.toFixed(2) + " $";
        }

        function submitForm() {
            document.getElementById("editInvoiceForm").submit();
        }
    </script>

    <style>
        .form-container { width: 80%; margin: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        th { background-color: #f4f4f4; }
        button { padding: 5px 10px; cursor: pointer; }
        .total-amount { font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="form-container">
        <h2>Edit Invoice</h2>

        <form id="editInvoiceForm" th:action="@{/invoices/{id}/edit(id=${invoice.id})}" method="post">
            <input type="hidden" name="id" th:value="${invoice.id}">
            <input type="hidden" id="deletedItemsInput" name="deletedItemIds" value="">

            <!-- Add New Item Section -->
            <h3>Add Item</h3>
            <label>Select Item:</label>
            <select id="itemSelect">
                <option value="" disabled selected>Choose an item</option>
                <option th:each="item : ${items}" 
                        th:value="${item.id}" 
                        th:text="${item.name} + ' - ' + ${item.price} + ' $'">
                </option>
            </select>

            <label>Price:</label>
            <input type="number" id="priceInput" step="0.01" min="0">

            <label>Quantity:</label>
            <input type="number" id="quantityInput" min="1">

            <button type="button" onclick="addItem()">Add Item</button>

            <!-- Invoice Items Table -->
            <h3>Invoice Items</h3>
            <table id="invoiceItemsTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="invoiceItem : ${invoiceItems}">
                        <td>
                            <input type="hidden" name="itemIds" th:value="${invoiceItem.item.id}">
                            <span th:text="${invoiceItem.item.name}"></span>
                        </td>
                        <td>
                            <input type="number" name="prices" th:value="${invoiceItem.price}" step="0.01" min="0" onchange="updateTotal()">
                        </td>
                        <td>
                            <input type="number" name="quantities" th:value="${invoiceItem.quantity}" min="1" onchange="updateTotal()">
                        </td>
                        <td>
                            <button type="button" th:attr="onclick='removeItem(this,' + ${invoiceItem.id} + ')'">Remove</button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Total Amount -->
            <h3 class="total-amount">Total: <span id="totalAmount" th:text="${invoice.total} + ' $'"></span></h3>

            <!-- Submit Button -->
            <button type="button" onclick="submitForm()">Save Changes</button>
        </form>
    </div>
</body>
</html>
