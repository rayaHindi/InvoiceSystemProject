<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Edit Invoice</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
	<style>
		td {
				    height: 100%; /* Ensure uniform height */
				    vertical-align: middle; /* Align content vertically */
				    padding: 10px; /* Add padding for consistency */
				}

				/* Adjust the Actions column */
				.action-buttons {
				    display: flex;
				    justify-content: center;
				    gap: 5px;
				    align-items: center; /* Align buttons to the center */
				    height: 100%; /* Ensure it does not shrink */
				}

				/* Ensure buttons take equal space and do not stretch row */
				.action-buttons a, .action-buttons button {
				    flex: 1;
				    padding: 8px 12px;
				    border: none;
				    cursor: pointer;
				    font-weight: bold;
				    border-radius: 5px;
				    text-decoration: none;
				    text-align: center;
				    color: white;
				    height: 35px; /* Set a fixed height to match the row */
				    display: flex;
				    align-items: center;
				    justify-content: center;
				}

				/* Button Colors */
				.edit-btn {
				    background-color: rgb(0, 128, 255);
				}

				.track-btn {
				    background-color: rgb(255, 165, 0);
				}

				.delete-btn {
				    background-color: rgb(255, 0, 0);
				}

				/* Button Hover Effects */
				.edit-btn:hover {
				    background-color: rgb(0, 100, 200);
				}

				.track-btn:hover {
				    background-color: rgb(200, 140, 0);
				}

				.delete-btn:hover {
				    background-color: rgb(200, 0, 0);
				}
				.formButton{
					width: 50%;
					background:transparent;
					box-shadow: none;	
					padding-left: 0;
					padding-right: 0;
					height: 50px;
				}
				.mini-table {
				    width: 100%;
				    border-collapse: collapse;
				}

				.mini-table th, .mini-table td {
				    border: 1px solid #ddd;
				    padding: 5px;
				    text-align: center;
					color: rgb(128, 0, 64);
				}

				.mini-table th {
				    background-color: #f4f4f4;
				    font-weight: bold;
				}

	</style>
    <script>
        let itemIndex = [[${invoiceItems.size()}]]; // Start from the last existing index

        function addItem() {
            const itemSelect = document.getElementById("itemSelect");
            const quantityInput = document.getElementById("quantityInput");

            const itemId = itemSelect.value;
            const itemName = itemSelect.options[itemSelect.selectedIndex].text;
            const itemPrice = parseFloat(itemSelect.options[itemSelect.selectedIndex].getAttribute("data-price"));
            const quantity = quantityInput.value;

            if (!itemId || quantity <= 0) {
                alert("Please select a valid item and enter a quantity.");
                return;
            }

            const itemTable = document.getElementById("invoiceItemsTable").querySelector("tbody");

            const newRow = document.createElement("tr");
            newRow.innerHTML = `
                <td>
                    <input type="hidden" name="invoiceItems[${itemIndex}].itemId" value="${itemId}">
                    ${itemName}
                </td>
                <td><span class="price">${itemPrice.toFixed(2)} $</span></td>
                <td>
                    <input type="number" name="invoiceItems[${itemIndex}].quantity" value="${quantity}" min="1" oninput="updateTotal()">
                </td>
                <td>
                    <button type="button" onclick="removeItem(this)">Remove</button>
                </td>
            `;

            itemTable.appendChild(newRow);
            itemIndex++; // Increment index for next item
            quantityInput.value = ""; // Reset quantity input
            updateTotal();
        }

        function removeItem(button) {
            const row = button.closest("tr");
            row.remove();
            updateTotal();
        }

        function submitForm() {
            document.getElementById("editInvoiceForm").submit();
        }

        function updateTotal() {
            let total = 0;
            document.querySelectorAll("#invoiceItemsTable tbody tr").forEach(row => {
                const price = parseFloat(row.querySelector(".price").textContent.replace(" $", "")) || 0;
                const quantity = parseInt(row.querySelector("input[type='number']").value) || 0;
                total += price * quantity;
            });
            document.getElementById("totalAmount").textContent = total.toFixed(2) + " $";
        }
    </script>
</head>
<body>
    <div class="dashboard-container">
        <h2>Edit Invoice</h2>

        <form id="editInvoiceForm" th:action="@{/invoices/{id}/edit(id=${invoice.id})}" method="post">
            <input type="hidden" name="id" th:value="${invoice.id}">

            <!-- ✅ New "Add Item" Section -->
            <h3>Add Item to Invoice</h3>
            <label for="itemSelect">Select Item:</label>
            <select id="itemSelect">
                <option value="" disabled selected>Choose an item</option>
                <option th:each="item : ${items}" 
                        th:value="${item.id}" 
                        th:text="${item.name} + ' - ' + ${item.price} + ' $'"
                        th:attr="data-price=${item.price}">
                </option>
            </select>

            <label for="quantityInput">Quantity:</label>
            <input type="number" id="quantityInput" min="1">

            <button type="button" onclick="addItem()">Add Item</button>
<br>
<br>
            <!-- ✅ Invoice Items Table -->
            <h3>Invoice Items</h3>
            <table id="invoiceItemsTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Existing items -->
                    <tr th:each="invoiceItem, i : ${invoiceItems}">
                        <td>
                            <input type="hidden" th:name="'invoiceItems[' + ${i.index} + '].itemId'" th:value="${invoiceItem.item.id}">
                            <span th:text="${invoiceItem.item.name}"></span>
                        </td>
                        <td><span class="price" th:text="${invoiceItem.item.price} + ' $'"></span></td>
                        <td>
                            <input type="number" th:name="'invoiceItems[' + ${i.index} + '].quantity'" 
                                   th:value="${invoiceItem.quantity}" min="1" oninput="updateTotal()">
                        </td>
                        <td>
                            <button type="button" onclick="removeItem(this)">Remove</button>
                        </td>
                    </tr>
                </tbody>
            </table>

            <h3>Total: <span id="totalAmount" th:text="${invoice.total} + ' $'"></span></h3>

            <button type="button" onclick="submitForm()">Save Changes</button>
        </form>
    </div>
</body>
</html>
